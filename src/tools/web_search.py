import json
from ddgs import DDGS
from tools.base import Tool


class WebSearchTool(Tool):
    name = "web_search"
    description = "Выполняет поиск в интернете через DuckDuckGo и возвращает результаты в формате JSON"

    parameters = {
        "type": "object",
        "properties": {
            "query": {"type": "string", "description": "Поисковый запрос"},
            "max_results": {
                "type": "integer",
                "description": "Максимальное количество результатов",
                "minimum": 1,
                "maximum": 20,
                "default": 5
            }
        },
        "required": ["query"]
    }

    def __init__(self):
        self.ddgs = DDGS()

    def run(self, query: str, max_results: int = 5, **_) -> str:
        try:
            # Выполняем поиск
            results = self.ddgs.text(query, max_results=max_results)

            # Форматируем результаты
            formatted_results = []
            for result in results:
                if 'body' in result:
                    formatted_results.append({
                        "title": result['title'],
                        "url": result['href'],
                        "snippet": result['body']
                    })

            if not formatted_results:
                return "[web_search] Ничего не найдено"

            return json.dumps(formatted_results, ensure_ascii=False, indent=2)

        except Exception as e:
            return f"[web_search] Ошибка: {e}"
